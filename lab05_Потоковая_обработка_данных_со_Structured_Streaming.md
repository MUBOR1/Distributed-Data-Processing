# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ5: –ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ Structured Streaming

## –¶–µ–ª—å —Ä–∞–±–æ—Ç—ã
–û—Å–≤–æ–∏—Ç—å –æ—Å–Ω–æ–≤—ã –ø–æ—Ç–æ–∫–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é Apache Spark Structured Streaming. –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —á—Ç–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫–æ–ª—å–∑—è—â–∏—Ö –∞–≥—Ä–µ–≥–∞—Ü–∏–π –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ß–∞—Å—Ç—å 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Socket
***–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:***
```python
# –ó–∞–ø—É—Å–∫ netcat-—Å–µ—Ä–≤–µ—Ä–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)
import socket
import time
import random

HOST = "localhost"
PORT = 9999

# –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: timestamp,user_id,action,value
# –ü—Ä–∏–º–µ—Ä: 2024-01-15 10:00:01,user1,click,5
```

![–°–ö–†–ò–ù–®–û–¢ 1: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö](./image/lb5startserver.png)

üì∑ *[–°–ö–†–ò–ù–®–û–¢ 1: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö]*

### –ß–∞—Å—Ç—å 2: –ß—Ç–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
***–ö–æ–¥:***
```python
from pyspark.sql import SparkSession

spark = SparkSession.builder \
    .appName("StructuredStreamingLab") \
    .getOrCreate()

# –ß—Ç–µ–Ω–∏–µ –∏–∑ socket
stream_df = spark.readStream \
    .format("socket") \
    .option("host", "localhost") \
    .option("port", 9999) \
    .load()
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ—Ç–æ–∫–æ–≤—ã–π DataFrame —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ socket –Ω–∞ –ø–æ—Ä—Ç—É 9999.

### –ß–∞—Å—Ç—å 3: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
***–ö–æ–¥:***
```python
from pyspark.sql.functions import *

# –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
parsed_df = stream_df.select(
    split(col("value"), ",").getItem(0).alias("timestamp"),
    split(col("value"), ",").getItem(1).alias("user_id"),
    split(col("value"), ",").getItem(2).alias("action"),
    split(col("value"), ",").getItem(3).cast("integer").alias("value")
)

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º
result_df = parsed_df.groupBy("action").agg(
    count("*").alias("count"),
    sum("value").alias("total_value")
)
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–∞—Ä—Å—è—Ç—Å—è –∏ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –ø–æ –ø–æ–ª—é "action".

### –ß–∞—Å—Ç—å 4: –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
***–ö–æ–¥:***
```python
query = result_df.writeStream \
    .outputMode("complete") \
    .format("console") \
    .start()

query.awaitTermination()
```

![–°–ö–†–ò–ù–®–û–¢ 2: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏](./image/lb5query.png)

üì∑ *[–°–ö–†–ò–ù–®–û–¢ 2: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏]*

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
### –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
```
–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:
2024-01-15 10:00:01,user1,click,5
2024-01-15 10:00:02,user2,purchase,100
2024-01-15 10:00:03,user1,click,3
```
### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–∏:
***Batch: 0*** (–Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)

```
+------+-----+-----------+
|action|count|total_value|
+------+-----+-----------+
+------+-----+-----------+

Batch: 1 (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
+--------+-----+-----------+
|  action|count|total_value|
+--------+-----+-----------+
|   login|    4|        220|
|purchase|    3|        100|
|    view|    5|        271|
|   click|    5|        124|
+--------+-----+-----------+

Batch: 6 (—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
+--------+-----+-----------+
|  action|count|total_value|
+--------+-----+-----------+
|   login|   16|        771|
|purchase|   18|        959|
|    view|   25|       1458|
|   click|   14|        601|
+--------+-----+-----------+
```
![–°–ö–†–ò–ù–®–û–¢ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–∏](./image/lb5analize.png)

üì∑ *[–°–ö–†–ò–ù–®–û–¢ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–∏]*

## –û—Ç–≤–µ—Ç—ã –Ω–∞ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã
### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ Structured Streaming:

1. ***–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:***
- –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏

2. ***Event-time –æ–±—Ä–∞–±–æ—Ç–∫–∞:***
- –í –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–±—ã—Ç–∏—è (timestamp –≤ –¥–∞–Ω–Ω—ã—Ö)

3. ***Output Modes:***

- ***Complete:*** –í—ã–≤–æ–¥ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
- ***Update:*** –í—ã–≤–æ–¥ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
- ***Append:*** –í—ã–≤–æ–¥ —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫

4. ***–í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏ (Watermarks):***
- –ú–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–µ—Ä–∂–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –≤ –¥–∞–Ω–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è
